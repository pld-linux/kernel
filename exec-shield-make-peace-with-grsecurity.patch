--- exec-shield-on-nx-2.6.7-rc2-bk2-A9.org	2004-06-27 02:56:05.713193032 +0200
+++ exec-shield-on-nx-2.6.7-rc2-bk2-A9	2004-06-27 03:17:55.149128512 +0200
@@ -787,12 +787,12 @@
  #include <linux/percpu.h>
  
  struct exec_domain;
+ struct linux_binprm;
 +extern int exec_shield;
 +extern int exec_shield_randomize;
 +extern int print_fatal_signals;
  
  /*
-  * cloning flags:
 @@ -196,6 +199,8 @@ struct mm_struct {
  	struct rb_root mm_rb;
  	struct vm_area_struct * mmap_cache;	/* last find_vma result */
@@ -1763,23 +1763,23 @@
  /*
   * vma is the first one with address > vma->vm_end.  Have to extend vma.
 @@ -1183,7 +1197,7 @@ int expand_stack(struct vm_area_struct *
- 		return -ENOMEM;
- 	}
- 	
+	if (vma->vm_flags & VM_LOCKED)
+		gr_learn_resource(current, RLIMIT_MEMLOCK, (vma->vm_mm->locked_vm + grow) << PAGE_SHIFT, 1);
+
 -	if (address - vma->vm_start > current->rlim[RLIMIT_STACK].rlim_cur ||
 +	if (over_stack_limit(address - vma->vm_start) ||
  			((vma->vm_mm->total_vm + grow) << PAGE_SHIFT) >
- 			current->rlim[RLIMIT_AS].rlim_cur) {
- 		anon_vma_unlock(vma);
+ 			current->rlim[RLIMIT_AS].rlim_cur ||
+			((vma->vm_flags & VM_LOCKED) &&
 @@ -1244,7 +1258,7 @@ int expand_stack(struct vm_area_struct *
- 		return -ENOMEM;
- 	}
- 	
+	if (vma->vm_flags & VM_LOCKED)
+		gr_learn_resource(current, RLIMIT_MEMLOCK, (vma->vm_mm->locked_vm + grow) << PAGE_SHIFT, 1);
+
 -	if (vma->vm_end - address > current->rlim[RLIMIT_STACK].rlim_cur ||
 +	if (over_stack_limit(vma->vm_end - address) ||
  			((vma->vm_mm->total_vm + grow) << PAGE_SHIFT) >
- 			current->rlim[RLIMIT_AS].rlim_cur) {
- 		anon_vma_unlock(vma);
+ 			current->rlim[RLIMIT_AS].rlim_cur ||
+			((vma->vm_flags & VM_LOCKED) &&
 @@ -1357,6 +1371,7 @@ no_mmaps:
  static void unmap_vma(struct mm_struct *mm, struct vm_area_struct *area)
  {
