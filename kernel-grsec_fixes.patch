netlink
cap_dac*
diff -upr a/grsecurity/gracl_cap.c c/grsecurity/gracl_cap.c
--- a/grsecurity/gracl_cap.c	2007-12-01 00:54:57.312774500 +0000
+++ c/grsecurity/gracl_cap.c	2007-12-01 01:09:34.923621750 +0000
@@ -110,3 +110,19 @@ gr_is_capable_nolog(const int cap)
 	return 0;
 }

+void
+gr_log_cap_pid(const int cap, const pid_t pid)
+{
+	struct task_struct *p;
+
+	if (gr_acl_is_enabled()) {
+		read_lock(&tasklist_lock);
+		p = find_task_by_vpid(pid);
+		if (p) {
+			get_task_struct(p);
+			gr_log_cap(GR_DONT_AUDIT, GR_CAP_ACL_MSG, p, captab_log[cap]);
+		}
+		read_unlock(&tasklist_lock);
+	}
+	return;
+}
--- linux-2.6.35/include/linux/grsecurity.h~	2010-10-20 21:01:00.758532744 +0200
+++ linux-2.6.35/include/linux/grsecurity.h	2010-10-20 21:03:27.556754795 +0200
@@ -78,6 +78,7 @@
 void gr_log_textrel(struct vm_area_struct *vma);
 void gr_log_rwxmmap(struct file *file);
 void gr_log_rwxmprotect(struct file *file);
+void gr_log_cap_pid(const int cap, pid_t pid);
 
 int gr_handle_follow_link(const struct inode *parent,
 				 const struct inode *inode,
diff -upr a/security/commoncap.c c/security/commoncap.c
--- a/security/commoncap.c	2007-12-01 00:54:57.300773750 +0000
+++ c/security/commoncap.c	2007-12-01 01:09:34.923621750 +0000
@@ -55,8 +55,12 @@
 
 int cap_netlink_recv(struct sk_buff *skb, int cap)
 {
-	if (!cap_raised(current_cap(), cap) || !gr_is_capable(cap))
+	if (!cap_raised(current_cap(), cap) || !gr_is_capable(cap)) {
+#ifdef CONFIG_GRKERNSEC
+		gr_log_cap_pid(cap, NETLINK_CREDS(skb)->pid);
+#endif
 		return -EPERM;
+	}
 	return 0;
 }
 
--- linux-2.6.30/kernel/vserver/context.c~	2009-07-31 12:07:52.365267958 +0200
+++ linux-2.6.30/kernel/vserver/context.c	2009-07-31 12:43:04.991723596 +0200
@@ -122,7 +122,7 @@
 	// preconfig fs entries
 	for (index = 0; index < VX_SPACES; index++) {
 		spin_lock(&init_fs.lock);
-		init_fs.users++;
+		atomic_inc(&init_fs.users);
 		spin_unlock(&init_fs.lock);
 		new->vx_fs[index] = &init_fs;
 	}
@@ -197,7 +197,7 @@
 
 		fs = xchg(&vxi->vx_fs[index], NULL);
 		spin_lock(&fs->lock);
-		kill = !--fs->users;
+		kill = !atomic_dec_return(&fs->users);
 		spin_unlock(&fs->lock);
 		if (kill)
 			free_fs_struct(fs);
--- linux-2.6.30/kernel/vserver/space.c~	2009-07-31 12:07:52.398601243 +0200
+++ linux-2.6.30/kernel/vserver/space.c	2009-07-31 12:47:48.638394441 +0200
@@ -220,7 +220,7 @@
 	if (mask & CLONE_FS) {
 		write_lock(&fs_cur->lock);
 		current->fs = fs;
-		kill = !--fs_cur->users;
+		kill = !atomic_dec_return(&fs_cur->users);
 		spin_unlock(&fs_cur->lock);
 	}
 
@@ -278,7 +278,7 @@
 	if (mask & CLONE_FS) {
 		spin_lock(&fs_vxi->lock);
 		space->vx_fs = fs;
-		kill = !--fs_vxi->users;
+		kill = !atomic_dec_return(&fs_vxi->users);
 		spin_unlock(&fs_vxi->lock);
 	}
 
--- linux-2.6.28/fs/proc/Kconfig~       2008-11-20 23:26:34.000000000 +0100
+++ linux-2.6.28/fs/proc/Kconfig        2008-12-01 20:37:12.000000000 +0100
@@ -59,8 +59,8 @@
 	  limited in memory.
 
 config PROC_PAGE_MONITOR
- 	default n
-	depends on PROC_FS && MMU && !GRKERNSEC
+ 	default y
+	depends on PROC_FS && MMU
 	bool "Enable /proc page monitoring" if EXPERT
  	help
 	  Various /proc files exist to monitor process memory utilization:
--- linux-2.6.34/net/socket.c~	2010-07-06 15:35:03.398523320 +0200
+++ linux-2.6.34/net/socket.c	2010-07-06 15:35:26.021020905 +0200
@@ -1573,12 +1573,6 @@
 	newsock->type = sock->type;
 	newsock->ops = sock->ops;
 
-	if (gr_handle_sock_server_other(sock->sk)) {
-		err = -EPERM;
-		sock_release(newsock);
-		goto out_put;
-	}
-
 	err = gr_search_accept(sock);
 	if (err) {
 		sock_release(newsock);


--- linux-3.0/drivers/media/dvb/dvb-core/dvbdev.c~	2011-07-22 04:17:23.000000000 +0200
+++ linux-3.0/drivers/media/dvb/dvb-core/dvbdev.c	2011-08-24 11:19:07.516069406 +0200
@@ -192,7 +192,7 @@
 			const struct dvb_device *template, void *priv, int type)
 {
 	struct dvb_device *dvbdev;
-	struct file_operations *dvbdevfops;
+	file_operations_no_const *dvbdevfops;
 	struct device *clsdev;
 	int minor;
 	int id;
--- linux-3.0/drivers/media/dvb/dvb-core/dvb_demux.h~	2011-08-24 15:24:31.000000000 +0200
+++ linux-3.0/drivers/media/dvb/dvb-core/dvb_demux.h	2011-08-24 15:26:03.384849939 +0200
@@ -68,12 +68,12 @@
 	union {
 		struct dmx_ts_feed ts;
 		struct dmx_section_feed sec;
-	} feed;
+	} __no_const feed;
 
 	union {
 		dmx_ts_cb ts;
 		dmx_section_cb sec;
-	} cb;
+	} __no_const cb;
 
 	struct dvb_demux *demux;
 	void *priv;

--- linux-3.0/include/media/v4l2-ioctl.h.org	2011-08-24 15:35:57.122909533 +0200
+++ linux-3.0/include/media/v4l2-ioctl.h	2011-08-24 15:35:20.495331557 +0200
@@ -272,6 +272,7 @@
 	long (*vidioc_default)	       (struct file *file, void *fh,
 					bool valid_prio, int cmd, void *arg);
 };
+typedef struct v4l2_ioctl_ops __no_const v4l2_ioctl_ops_no_const;
 
 
 /* v4l debugging and diagnostics */
--- linux-3.0/include/media/saa7146_vv.h.org	2011-08-24 15:37:02.221195169 +0200
+++ linux-3.0/include/media/saa7146_vv.h	2011-08-24 15:34:23.920591283 +0200
@@ -163,7 +163,7 @@
 	int (*std_callback)(struct saa7146_dev*, struct saa7146_standard *);
 
 	/* the extension can override this */
-	struct v4l2_ioctl_ops ops;
+	v4l2_ioctl_ops_no_const ops;
 	/* pointer to the saa7146 core ops */
 	const struct v4l2_ioctl_ops *core_ops;
 
--- linux-3.0/drivers/media/dvb/dvb-usb/cxusb.c~	2011-07-22 04:17:23.000000000 +0200
+++ linux-3.0/drivers/media/dvb/dvb-usb/cxusb.c	2011-08-24 15:40:27.459629659 +0200
@@ -1059,7 +1059,7 @@
 struct dib0700_adapter_state {
 	int (*set_param_save) (struct dvb_frontend *,
 			       struct dvb_frontend_parameters *);
-};
+} __no_const;
 
 static int dib7070_set_param_override(struct dvb_frontend *fe,
 				      struct dvb_frontend_parameters *fep)
--- linux-3.0/drivers/media/dvb/frontends/dib3000.h~	2011-07-22 04:17:23.000000000 +0200
+++ linux-3.0/drivers/media/dvb/frontends/dib3000.h	2011-08-24 15:43:35.010954191 +0200
@@ -40,6 +40,7 @@
 	int (*pid_ctrl)(struct dvb_frontend *fe, int index, int pid, int onoff);
 	int (*tuner_pass_ctrl)(struct dvb_frontend *fe, int onoff, u8 pll_ctrl);
 };
+typedef struct dib_fe_xfer_ops __no_const dib_fe_xfer_ops_no_const;
 
 #if defined(CONFIG_DVB_DIB3000MB) || (defined(CONFIG_DVB_DIB3000MB_MODULE) && defined(MODULE))
 extern struct dvb_frontend* dib3000mb_attach(const struct dib3000_config* config,
--- linux-3.0/drivers/media/dvb/dvb-usb/dibusb.h.org	2011-08-24 15:44:18.638705537 +0200
+++ linux-3.0/drivers/media/dvb/dvb-usb/dibusb.h	2011-08-24 15:44:29.398971130 +0200
@@ -97,7 +97,7 @@
 #define DIBUSB_IOCTL_CMD_DISABLE_STREAM	0x02
 
 struct dibusb_state {
-	struct dib_fe_xfer_ops ops;
+	dib_fe_xfer_ops_no_const ops;
 	int mt2060_present;
 	u8 tuner_addr;
 };
--- linux-3.0/drivers/media/dvb/dvb-usb/dw2102.c~	2011-07-22 04:17:23.000000000 +0200
+++ linux-3.0/drivers/media/dvb/dvb-usb/dw2102.c	2011-08-24 15:47:08.916263060 +0200
@@ -95,7 +95,7 @@
 
 struct s6x0_state {
 	int (*old_set_voltage)(struct dvb_frontend *f, fe_sec_voltage_t v);
-};
+} __no_const ;
 
 /* debug */
 static int dvb_usb_dw2102_debug;
--- linux-3.0/drivers/media/dvb/frontends/dib3000.h~	2011-08-24 15:43:35.000000000 +0200
+++ linux-3.0/drivers/media/dvb/frontends/dib3000.h	2011-08-24 15:48:48.682071857 +0200
@@ -44,7 +44,7 @@
 
 #if defined(CONFIG_DVB_DIB3000MB) || (defined(CONFIG_DVB_DIB3000MB_MODULE) && defined(MODULE))
 extern struct dvb_frontend* dib3000mb_attach(const struct dib3000_config* config,
-					     struct i2c_adapter* i2c, struct dib_fe_xfer_ops *xfer_ops);
+					     struct i2c_adapter* i2c, dib_fe_xfer_ops_no_const *xfer_ops);
 #else
 static inline struct dvb_frontend* dib3000mb_attach(const struct dib3000_config* config,
 					     struct i2c_adapter* i2c, struct dib_fe_xfer_ops *xfer_ops)
--- linux-3.0/drivers/media/dvb/frontends/dib3000mb.c~	2011-07-22 04:17:23.000000000 +0200
+++ linux-3.0/drivers/media/dvb/frontends/dib3000mb.c	2011-08-24 15:48:25.304824157 +0200
@@ -756,7 +756,7 @@
 static struct dvb_frontend_ops dib3000mb_ops;
 
 struct dvb_frontend* dib3000mb_attach(const struct dib3000_config* config,
-				      struct i2c_adapter* i2c, struct dib_fe_xfer_ops *xfer_ops)
+				      struct i2c_adapter* i2c, dib_fe_xfer_ops_no_const *xfer_ops)
 {
 	struct dib3000_state* state = NULL;
 
--- linux-3.0/drivers/media/video/timblogiw.c~	2011-07-22 04:17:23.000000000 +0200
+++ linux-3.0/drivers/media/video/timblogiw.c	2011-08-24 15:51:45.306448917 +0200
@@ -745,7 +745,7 @@
 
 /* Platform device functions */
 
-static __devinitconst struct v4l2_ioctl_ops timblogiw_ioctl_ops = {
+static __devinitconst v4l2_ioctl_ops_no_const timblogiw_ioctl_ops = {
 	.vidioc_querycap		= timblogiw_querycap,
 	.vidioc_enum_fmt_vid_cap	= timblogiw_enum_fmt,
 	.vidioc_g_fmt_vid_cap		= timblogiw_g_fmt,
