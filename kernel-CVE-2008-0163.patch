--- linux-2.6.22/kernel/ptrace.c	2007-07-09 13:20:03 +0200
+++ linux-2.6.22-vs2.2.0-rc5/kernel/ptrace.c	2007-06-15 04:28:02 +0200
@@ -145,6 +146,8 @@ static int may_attach(struct task_struct
 		dumpable = task->mm->dumpable;
 	if (!dumpable && !capable(CAP_SYS_PTRACE))
 		return -EPERM;
+	if (!vx_check(task->xid, VX_ADMIN|VX_IDENT))
+		return -EPERM;
 
 	return security_ptrace(current, task);
 }
